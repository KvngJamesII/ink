<div class="container my-tasks-page">
  <h1 class="page-title">My Tasks</h1>
  
  <div class="tabs">
    <button class="tab-btn active" data-tab="created">Tasks I Created</button>
    <button class="tab-btn" data-tab="submissions">My Submissions</button>
  </div>
  
  <div class="tab-content active" id="created-tab">
    <h2>Tasks I Created</h2>
    <div class="task-submissions-list">
      <div class="loading">Loading submissions for review...</div>
    </div>
  </div>
  
  <div class="tab-content" id="submissions-tab">
    <h2>My Task Submissions</h2>
    <div class="my-submissions-list">
      <div class="loading">Loading your submissions...</div>
    </div>
  </div>
</div>

<style>
  .my-tasks-page {
    padding: 20px;
    max-width: 800px;
    margin: 0 auto;
    padding-bottom: 80px;
  }
  
  .tabs {
    display: flex;
    margin-bottom: 20px;
    background: rgba(255, 255, 255, 0.1);
    border-radius: 8px;
    overflow: hidden;
  }
  
  .tab-btn {
    flex: 1;
    padding: 12px;
    background: transparent;
    border: none;
    color: #fff;
    cursor: pointer;
    font-weight: 500;
  }
  
  .tab-btn.active {
    background: rgba(255, 255, 255, 0.2);
    position: relative;
  }
  
  .tab-btn.active::after {
    content: '';
    position: absolute;
    bottom: 0;
    left: 0;
    width: 100%;
    height: 3px;
    background: linear-gradient(90deg, #4d81ff, #7d5fff);
  }
  
  .tab-content {
    display: none;
  }
  
  .tab-content.active {
    display: block;
  }
  
  .task-submissions-list, .my-submissions-list {
    margin-top: 20px;
  }
  
  .submission-card {
    background: rgba(255, 255, 255, 0.1);
    border-radius: 8px;
    padding: 15px;
    margin-bottom: 15px;
    border: 1px solid rgba(255, 255, 255, 0.1);
    position: relative;
    overflow: hidden;
  }
  
  .submission-card::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    width: 5px;
    height: 100%;
  }
  
  .submission-card.pending::before {
    background: #f5c84c;
  }
  
  .submission-card.approved::before {
    background: #4caf50;
  }
  
  .submission-card.rejected::before {
    background: #f44336;
  }
  
  .submission-details {
    margin-bottom: 10px;
  }
  
  .submission-details h3 {
    margin: 0 0 5px 0;
    font-size: 18px;
  }
  
  .submission-proof {
    background: rgba(0, 0, 0, 0.2);
    padding: 10px;
    border-radius: 5px;
    margin-bottom: 10px;
    font-size: 15px;
  }
  
  .submission-actions {
    display: flex;
    gap: 10px;
  }
  
  .btn-approve, .btn-reject {
    padding: 8px 15px;
    border-radius: 4px;
    border: none;
    color: #fff;
    font-weight: 500;
    cursor: pointer;
  }
  
  .btn-approve {
    background: linear-gradient(45deg, #43a047, #66bb6a);
  }
  
  .btn-reject {
    background: linear-gradient(45deg, #e53935, #f44336);
  }
  
  .no-submissions {
    text-align: center;
    padding: 20px;
    background: rgba(255, 255, 255, 0.05);
    border-radius: 8px;
    color: #ccc;
  }
  
  .status-badge {
    display: inline-block;
    padding: 3px 8px;
    border-radius: 12px;
    font-size: 12px;
    margin-left: 8px;
  }
  
  .status-pending {
    background-color: #f5c84c;
    color: #000;
  }
  
  .status-approved {
    background-color: #4caf50;
    color: #fff;
  }
  
  .status-rejected {
    background-color: #f44336;
    color: #fff;
  }
  
  @media (max-width: 600px) {
    .submission-actions {
      flex-direction: column;
    }
    
    .btn-approve, .btn-reject {
      width: 100%;
    }
  }
</style>

<script>
  document.addEventListener('DOMContentLoaded', () => {
    // Tab switching functionality
    const tabButtons = document.querySelectorAll('.tab-btn');
    const tabContents = document.querySelectorAll('.tab-content');
    
    tabButtons.forEach(button => {
      button.addEventListener('click', () => {
        // Remove active class from all buttons and contents
        tabButtons.forEach(btn => btn.classList.remove('active'));
        tabContents.forEach(content => content.classList.remove('active'));
        
        // Add active class to clicked button and corresponding content
        button.classList.add('active');
        const tabId = button.getAttribute('data-tab');
        document.getElementById(`${tabId}-tab`).classList.add('active');
      });
    });
    
    // Load task submissions for review (as task creator)
    const loadSubmissionsForReview = async () => {
      const user = Auth.getCurrentUser();
      if (!user) return;
      
      try {
        const response = await fetch(`/api/users/${user.id}/review-submissions`);
        if (!response.ok) throw new Error('Failed to load submissions');
        
        const submissions = await response.json();
        const submissionsList = document.querySelector('.task-submissions-list');
        
        if (submissions.length === 0) {
          submissionsList.innerHTML = `
            <div class="no-submissions">
              <i class="fas fa-inbox" style="font-size: 32px; margin-bottom: 10px;"></i>
              <p>No task submissions to review yet.</p>
            </div>
          `;
          return;
        }
        
        submissionsList.innerHTML = '';
        
        submissions.forEach(item => {
          const submissionCard = document.createElement('div');
          submissionCard.className = `submission-card ${item.submission.status.toLowerCase()}`;
          
          submissionCard.innerHTML = `
            <div class="submission-details">
              <h3>${item.task.name}</h3>
              <p>Submitted by: ${item.submission.userId}</p>
              <p>Submitted on: ${new Date(item.submission.createdAt).toLocaleString()}</p>
              <p>Status: <span class="status-badge status-${item.submission.status.toLowerCase()}">${item.submission.status}</span></p>
            </div>
            <div class="submission-proof">
              <strong>Proof:</strong>
              <p>${item.submission.proofText}</p>
            </div>
            ${item.submission.status === 'pending' ? `
              <div class="submission-actions">
                <button class="btn-approve" data-id="${item.submission.id}">Approve</button>
                <button class="btn-reject" data-id="${item.submission.id}">Reject</button>
              </div>
            ` : ''}
          `;
          
          submissionsList.appendChild(submissionCard);
        });
        
        // Add event listeners to buttons
        document.querySelectorAll('.btn-approve').forEach(button => {
          button.addEventListener('click', async (e) => {
            const submissionId = e.target.getAttribute('data-id');
            await reviewSubmission(submissionId, 'approved');
          });
        });
        
        document.querySelectorAll('.btn-reject').forEach(button => {
          button.addEventListener('click', async (e) => {
            const submissionId = e.target.getAttribute('data-id');
            await reviewSubmission(submissionId, 'rejected');
          });
        });
        
      } catch (error) {
        console.error('Error loading submissions:', error);
        document.querySelector('.task-submissions-list').innerHTML = `
          <div class="error-message">
            Failed to load submissions. Please try again.
          </div>
        `;
      }
    };
    
    // Load user's own submissions
    const loadMySubmissions = async () => {
      const user = Auth.getCurrentUser();
      if (!user) return;
      
      try {
        const response = await fetch(`/api/users/${user.id}/submissions`);
        if (!response.ok) throw new Error('Failed to load submissions');
        
        const submissions = await response.json();
        const submissionsList = document.querySelector('.my-submissions-list');
        
        if (submissions.length === 0) {
          submissionsList.innerHTML = `
            <div class="no-submissions">
              <i class="fas fa-clipboard-list" style="font-size: 32px; margin-bottom: 10px;"></i>
              <p>You haven't submitted any tasks yet.</p>
            </div>
          `;
          return;
        }
        
        submissionsList.innerHTML = '';
        
        submissions.forEach(submission => {
          const submissionCard = document.createElement('div');
          submissionCard.className = `submission-card ${submission.status.toLowerCase()}`;
          
          submissionCard.innerHTML = `
            <div class="submission-details">
              <h3>Task #${submission.taskId}</h3>
              <p>Submitted on: ${new Date(submission.createdAt).toLocaleString()}</p>
              <p>Status: <span class="status-badge status-${submission.status.toLowerCase()}">${submission.status}</span></p>
            </div>
            <div class="submission-proof">
              <strong>Your proof:</strong>
              <p>${submission.proofText}</p>
            </div>
          `;
          
          submissionsList.appendChild(submissionCard);
        });
        
      } catch (error) {
        console.error('Error loading submissions:', error);
        document.querySelector('.my-submissions-list').innerHTML = `
          <div class="error-message">
            Failed to load your submissions. Please try again.
          </div>
        `;
      }
    };
    
    // Function to review submission (approve/reject)
    const reviewSubmission = async (submissionId, status) => {
      const user = Auth.getCurrentUser();
      if (!user) return;
      
      try {
        const response = await fetch(`/api/submissions/${submissionId}/review`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            reviewerId: user.id,
            status
          })
        });
        
        if (!response.ok) {
          const errorData = await response.json();
          throw new Error(errorData.message || 'Failed to review submission');
        }
        
        // Reload submissions after review
        loadSubmissionsForReview();
        
        // Show success message
        const message = status === 'approved' ? 'Submission approved successfully!' : 'Submission rejected';
        showNotification(message, status === 'approved' ? 'success' : 'error');
        
      } catch (error) {
        console.error('Error reviewing submission:', error);
        showNotification(error.message || 'Failed to review submission', 'error');
      }
    };
    
    // Show notification function
    const showNotification = (message, type = 'success') => {
      // Check if notification container exists
      let notifContainer = document.querySelector('.notification-container');
      
      if (!notifContainer) {
        notifContainer = document.createElement('div');
        notifContainer.className = 'notification-container';
        document.body.appendChild(notifContainer);
        
        // Add styles if not exists
        if (!document.querySelector('#notification-styles')) {
          const style = document.createElement('style');
          style.id = 'notification-styles';
          style.textContent = `
            .notification-container {
              position: fixed;
              top: 20px;
              right: 20px;
              z-index: 9999;
            }
            .notification {
              padding: 12px 20px;
              margin-bottom: 10px;
              border-radius: 4px;
              color: white;
              box-shadow: 0 4px 8px rgba(0,0,0,0.2);
              display: flex;
              align-items: center;
              animation: slideIn 0.3s ease-out forwards;
              max-width: 300px;
            }
            .notification.success {
              background: linear-gradient(45deg, #43a047, #66bb6a);
            }
            .notification.error {
              background: linear-gradient(45deg, #e53935, #f44336);
            }
            .notification.info {
              background: linear-gradient(45deg, #1e88e5, #42a5f5);
            }
            @keyframes slideIn {
              from { transform: translateX(100%); opacity: 0; }
              to { transform: translateX(0); opacity: 1; }
            }
            @keyframes fadeOut {
              from { opacity: 1; }
              to { opacity: 0; }
            }
          `;
          document.head.appendChild(style);
        }
      }
      
      // Create notification
      const notification = document.createElement('div');
      notification.className = `notification ${type}`;
      notification.textContent = message;
      
      // Add to container
      notifContainer.appendChild(notification);
      
      // Remove after 4 seconds
      setTimeout(() => {
        notification.style.animation = 'fadeOut 0.3s ease-out forwards';
        setTimeout(() => {
          notification.remove();
        }, 300);
      }, 4000);
    };
    
    // Load data when page loads
    loadSubmissionsForReview();
    loadMySubmissions();
  });
</script>