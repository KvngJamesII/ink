<div class="page-content">
  <div class="container" style="padding-top: 1rem;">
    <div class="card">
      <div class="card-header">
        <h1 class="card-title">Welcome to QuicReF</h1>
        <p class="card-subtitle">Find and complete tasks to earn money</p>
      </div>
      <div class="card-content">
        <div id="tasks-loader" class="text-center py-4">
          <div class="loading-spinner" style="margin: 0 auto;"></div>
          <p class="mt-3">Loading available tasks...</p>
        </div>
        
        <div id="no-tasks" class="hidden text-center py-4">
          <div style="font-size: 3rem; color: #666; margin-bottom: 1rem;">
            <i class="fas fa-clipboard-list"></i>
          </div>
          <p>No tasks available right now.</p>
          <p class="mt-2">Check back later or create your own task!</p>
        </div>
        
        <div id="tasks-container" class="hidden">
          <!-- Tasks will be dynamically inserted here -->
        </div>
      </div>
    </div>
  </div>
</div>

<script>
function inithomePage() {
  // Add font awesome if not already added
  if (!document.querySelector('link[href*="font-awesome"]')) {
    const link = document.createElement('link');
    link.rel = 'stylesheet';
    link.href = 'https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css';
    document.head.appendChild(link);
  }
  
  document.title = "QuicReF - Task Platform";
  
  // Load available tasks
  loadAvailableTasks();
}

async function loadAvailableTasks() {
  try {
    const loaderElement = document.getElementById('tasks-loader');
    const noTasksElement = document.getElementById('no-tasks');
    const tasksContainerElement = document.getElementById('tasks-container');
    
    // Get current user (if any) to check which tasks they can work on
    const currentUser = Auth.getCurrentUser();
    
    // Fetch tasks from Firestore
    const db = firebase.firestore();
    const tasksQuery = await db.collection('tasks')
      .where('active', '==', true)
      .orderBy('createdAt', 'desc')
      .get();
    
    // Hide loader
    loaderElement.classList.add('hidden');
    
    if (tasksQuery.empty) {
      // Show no tasks message
      noTasksElement.classList.remove('hidden');
    } else {
      // Show tasks container
      tasksContainerElement.classList.remove('hidden');
      
      // Process tasks
      const tasksHTML = [];
      
      tasksQuery.forEach(doc => {
        const task = { id: doc.id, ...doc.data() };
        
        // Skip tasks that the user can't work on
        if (currentUser && task.ownerId === currentUser.uid) {
          return; // Skip own tasks
        }
        
        // Check if the user has already completed this task
        if (currentUser && task.completedBy && task.completedBy.includes(currentUser.uid)) {
          return; // Skip tasks already completed by user
        }
        
        // Check if task is full
        if (task.filledSlots >= task.totalSlots) {
          return; // Skip full tasks
        }
        
        // Calculate progress percentage
        const progressPercentage = (task.filledSlots / task.totalSlots) * 100;
        
        // Create task card HTML
        tasksHTML.push(`
          <div class="task-card" onclick="Router.navigate('/task/${task.id}')">
            <div class="task-header">
              <div class="task-title">${escapeHtml(task.name)}</div>
              <div class="task-price">$${task.pricePerUser.toFixed(2)}</div>
            </div>
            <div class="task-body">
              <div class="task-info">
                <div class="task-creator">by ${maskEmail(task.ownerEmail || "")}</div>
                <div class="task-slots">${task.filledSlots}/${task.totalSlots} slots filled</div>
              </div>
              <div class="task-description">${escapeHtml(task.description || "").substring(0, 100)}${task.description && task.description.length > 100 ? '...' : ''}</div>
            </div>
            <div class="task-footer">
              <div class="task-fill-progress">
                <div class="progress-bar" style="width: ${progressPercentage}%"></div>
              </div>
            </div>
          </div>
        `);
      });
      
      // Add tasks to container
      if (tasksHTML.length > 0) {
        tasksContainerElement.innerHTML = tasksHTML.join('');
      } else {
        // No tasks available for this user
        noTasksElement.classList.remove('hidden');
      }
    }
  } catch (error) {
    console.error('Error loading tasks:', error);
    document.getElementById('tasks-loader').innerHTML = `
      <div class="alert alert-error">
        <p>Error loading tasks. Please try again.</p>
        <p class="mt-2">${error.message}</p>
      </div>
      <button class="btn btn-primary btn-block mt-3" onclick="loadAvailableTasks()">
        Retry
      </button>
    `;
  }
}

// Helper to mask email for privacy
function maskEmail(email) {
  if (!email) return "";
  const parts = email.split('@');
  if (parts.length !== 2) return email;
  
  const name = parts[0];
  const domain = parts[1];
  
  let maskedName = '';
  if (name.length <= 2) {
    maskedName = name[0] + '*';
  } else {
    maskedName = name[0] + '*'.repeat(name.length - 2) + name[name.length - 1];
  }
  
  return maskedName + '@' + domain;
}

// Helper to escape HTML to prevent XSS
function escapeHtml(unsafe) {
  if (!unsafe) return '';
  return unsafe
    .replace(/&/g, "&amp;")
    .replace(/</g, "&lt;")
    .replace(/>/g, "&gt;")
    .replace(/"/g, "&quot;")
    .replace(/'/g, "&#039;");
}
</script>